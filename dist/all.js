function getAiAngle(d){for(var e=[],h=Math.floor(194+d.bradius),j=Math.floor(d.height-(194+d.bradius)),m=h;m<=j;m++)e[m-h]=m;var o=[];d.traectories=[];for(var m=0;m<e.length;m++)o.push(function(E){var F=d.leftLine.start.x,G=d.ball.x,H=d.ball.y,I=d.bradius,J=d.radius,K=I+J;console.log('ai');var L=[],M=continueLine(F,E,G,H,0);L.push([{x:F,y:E,x1:G,y1:H,x2:M.x,y2:M.y,direction:0}]);var N=d.ty,O=d.by,P=function(){var T=E-N,V=F+T*(G-F)/(T+(H-N)),W=Phaser.Math.angleBetween(G,H,V,N),X=tanc(V,G,N,H),Y=K*Math.sin(W),Z=K*Math.cos(W);return{x:F,y:E,x1:V,y1:N,x2:G,y2:H,direction:1}}();M=continueLine(P.x1,P.y1,P.x2,P.y2,0),L.push([{x:P.x,y:P.y,x1:P.x1,y1:P.y1},{x:P.x1,y:P.y1,x1:G,y1:H,x2:M.x,y2:M.y,direction:2}]);var P=function(){var T=O-E,V=F+T*(G-F)/(T+(O-H)),W=Phaser.Math.angleBetween(G,H,V,N),X=tanc(V,G,N,H),Y=K*Math.sin(W),Z=K*Math.cos(W);return{x:F,y:E,x1:V,y1:O,x2:G,y2:H}}();M=continueLine(P.x1,P.y1,P.x2,P.y2,0),L.push([{x:P.x,y:P.y,x1:P.x1,y1:P.y1},{x:P.x1,y:P.y1,x1:G,y1:H,x2:M.x,y2:M.y}]);var Q=[];L.forEach(function(S){var U=!0;S.forEach(function(Z){var Z=findNormal({x:Z.x,y:Z.y,x1:Z.x1,y1:Z.y1,curang:toGrad(Phaser.Math.angleBetween(Z.x,Z.y,Z.x1,Z.y1))},-1,I);0<Z.newtracks.length&&(U=!1)}),S.forEach(function(Z){U&&d.traectories.push(new Phaser.Line(Z.x,Z.y,Z.x1,Z.y1))});var V=S[S.length-1],W=V.x2,X=V.y2,Y=d.redGroup.children.map(function(Z){var _=180,aa=new Phaser.Point(W,X),ba=new Phaser.Point(Z.x,Z.y);_=Phaser.Math.angleBetweenPoints(aa,ba);var ca=findNormal({x:Z.x,y:Z.y,x1:W,y1:X,curang:toGrad(_)},Z.idx,J),da=!1;return 0==ca.newtracks.length&&infield(W,X)&&(console.log(aa,ba),d.traectories.push(new Phaser.Line(Z.x,Z.y,W,X)),da=!0),{ang:_,x:Z.x,y:Z.y,nearest:Math.abs(G-Z.x),direction:V.direction,id:Z.id,isCan:da,isCanTr:U}});Q=Q.concat(Y)}),Q=Q.filter(function(S){return 0!=S.ang});var R=!1;return Q.some(function(S){return S.isCan&&S.isCanTr})&&(R=!0,Q=Q.filter(function(S){return S.isCan&&S.isCanTr})),anglse=Q.map(function(S){S.isCan=R}),Q}(e[m]));var q=[];o.forEach(function(E){E.forEach(function(F){q=q.concat(F)})}),o=q;var u=o.some(function(E){return E.isCan});u&&(o=o.filter(function(E){return E.isCan}));var w=d.angleSectors.map(function(E){return toRad(E)});console.log(o),o=splitArray(o,w,'ang'),console.log(o),d.firstPanch&&(o=o.filter(function(E){return 1==E.id||2==E.id}));var z=[],A=o.filter(function(E){return 0==E.direction})[0];A&&z.push(A);var B=o.filter(function(E){return 1==E.direction})[0];B&&z.push(B);var C=o.filter(function(E){return 2==E.direction})[0];C&&z.push(C);var D=z[Math.floor(Math.random()*z.length)];return D.angle=D.ang-Math.PI/2,D}function splitArray(d,e,h){function j(q,u){return q.nearest-u.nearest}var m=Array(e.length);d.forEach(q=>{var u=-1;e.forEach(w=>{Math.abs(q[h])>w&&++u}),m[u]||(m[u]=[]),m[u].push(q)}),console.log(m),m=m.map(q=>q.sort(j));var o=[];return m.forEach(q=>{o=o.concat(q)}),o}function findNormal(d,e,h){game.ids||(game.ids=[]);var j=game.radius+h,m=game.group.filter(z=>{return-1===e||z.idx!=e&&-1==game.ids.indexOf(z.idx)}),o=[],q=[];m.forEach(z=>{var A=tan(d.curang),B;if(0==A)var C=z.x,D=d.y,E=0,F=d.y;else{B=atan(A)-90;var E=tan(B),G=d.y-A*d.x,F=z.y-E*z.x,C=(F-G)/(A-E),D=E*C+F}var H=getLength(z.x,z.y,C,D);if(inrange(C,d.x,d.x1)&&H<j){o.push(new Phaser.Line(z.x,z.y,C,D));var I=Math.sqrt(j**2-H**2),J=sin(atan(A))*I,K=cos(atan(A))*I;if(C<z.x)var L=C+K;else var L=C-K;if(D<z.y)var M=D+J;else var M=D-J;var N=new Phaser.Line(z.x,z.y,L,M),O=tanc(z.x,L,z.y,M),P=atan(O);if(90<d.curang?P=180+P:-90>d.curang&&(P=-180-P),d.curang>P)var Q=P+90;else var Q=P-90;q.push({x:z.x,y:z.y,x1:L,y1:M,len:getLength(z.x,z.y,L,M),tn:O,ang:P,vec:N,ang2:Q})}});var u=q.reduce((z,A)=>{if(-1==z)return A.len;return A.len<z?A.len:z},-1),w=q.filter(z=>z.len==u);return{newtracks:w}}function continueLine(d,e,h,j,m){m==void 0&&(m=0);var o=Phaser.Math.angleBetween(d,e,h,j),q=game.bradius+game.radius;q-=Phaser.Math.linear(0,m,Math.random());var u=q*Math.sin(o),w=q*Math.cos(o);return{x:h+w,y:j+u}}function infield(d,e){var h=game.radius;return game.lx+h<=d&&d<=game.rx-h&&game.tx+h<=e&&e<=game.by-h}var gui=new dat.GUI,game=new Phaser.Game({width:820,height:530,renderer:Phaser.CANVAS,parent:'parent',transparent:!0,state:{transparent:!0,preload:preload,create:create,update,render}}),degToRad=Phaser.Math.degToRad,rotate=function(d){return degToRad(d+90)};function preload(){game.load.image('redPl','assets/red.png'),game.load.image('bluePl','assets/blue.png'),game.load.image('circle50','assets/circle50.png'),game.load.image('select','assets/select.png'),game.load.image('hit_arrow','assets/hit_arrow.png'),game.load.image('hit_area','assets/player_hitarea.png'),game.load.image('dot','assets/dot_hit.png'),game.load.image('dots','assets/dots.png'),game.load.image('pl','pangball.png'),game.load.image('ball','assets/ball.png'),game.load.image('gate','assets/gate.png'),game.load.image('goal','assets/goal.png'),game.load.image('win','assets/win.png'),game.load.image('fall','assets/fall.png'),game.load.image('p1','assets/particles/p1.png'),game.load.image('p2','assets/particles/p2.png'),game.load.image('p3','assets/particles/p3.png'),game.load.image('p4','assets/particles/p4.png'),game.load.image('p5','assets/particles/p5.png'),game.load.image('p6','assets/particles/p6.png'),game.load.image('p7','assets/particles/p7.png'),game.load.image('p8','assets/particles/p8.png')}game.initGame=function(){game.scores={red:0,blue:0},game.firstPanch=!0,game.stepTimeLeft=game.stepTimeTotal,game._stepTimeLeft=game.time.time,game.updateDisplay=500,game.timeId=game.time.time,game.isGameOver=!1,game.incSpeed=0,200*Math.floor(4*Math.random()),game.incSpeedP=0,500*Math.floor(4*Math.random()),game.incPower=0,200*Math.floor(4*Math.random()),game.incPowerP=0,500*Math.floor(4*Math.random())},game.angleSectors=[0,25,45,90,120],game.angleSectorsString=game.angleSectors.join(', '),game.stepTimeTotal=300000,game.check=function(){return 1<game.scores.red||1<game.scores.blue},game.freeze=function(){game.blueGroup.children.forEach(function(d){d.body.setZeroVelocity()}),game.redGroup.children.forEach(function(d){d.body.setZeroVelocity()}),game.ball.body.setZeroVelocity()},game.fallStrikeSignal=new Phaser.Signal,game.fallStrikeSignal.add(function(){game.freeze(),game.fall.visible=!0,setTimeout(function(){game.fall.visible=!1,game.nextTime(game.blueCommand)},2e3)}),game.nextTime=function(d){game.stepTimeLeft=game.stepTimeTotal,game._stepTimeLeft=game.time.time,game.firstPanch=!0,game.guiLevel.updateDisplay(),game.redGroup.children.forEach(function(e){e.body.x=game.redTeamCoords[e.id].x,e.body.y=game.redTeamCoords[e.id].y}),game.blueGroup.children.forEach(function(e){e.body.x=game.blueTeamCoords[e.id].x,e.body.y=game.blueTeamCoords[e.id].y}),game.ball.body.x=game.ballCoord.x,game.ball.body.y=game.ballCoord.y,game.freeze(),game.blueCommand=!1,d&&(game.blueCommand=!0),game.nextStepSignal.dispatch()};function create(){game.initGame(),game.physics.startSystem(Phaser.Physics.BOX2D),game.physics.box2d.setBoundsToWorld(),game.stage.backgroundColor='#12418400',game.physics.box2d.gravity.y=0,game.physics.box2d.restitution=1,game.centerLine=new Phaser.Line(game.width/2,(game.height-405)/2,game.width/2,(game.height-405)/2+405),game.leftLine=new Phaser.Line(60,(game.height-405)/2,60,(game.height-405)/2+405),game.rightLine=new Phaser.Line(game.width-60,(game.height-405)/2,game.width-60,(game.height-405)/2+405),game.mass=5,game.massP=5,game.power=1e3,game.powerP=1e3,game.ballMass=1,game.damping=2,game.dampingP=2,game.ballDamping=2,game.speedOut=6,game.redTeamCoords=[{x:game.width-340,y:265},{x:game.width-285,y:380},{x:game.width-285,y:150},{x:game.width-200,y:220},{x:game.width-200,y:310}],game.blueTeamCoords=[{x:340,y:265},{x:285,y:380},{x:285,y:150},{x:200,y:220},{x:200,y:310}],game.ballCoord={x:410,y:265},game.blueCommand=!!(0.5>Math.random()),game.redGroup={children:[]},game.blueGroup={children:[]},game.hitArea=game.add.group();var d=game.add.sprite(0,0,'hit_arrow');game.arrow=d,d.anchor.set(0.5,1.3);var e=game.add.sprite(0,0,'hit_area');e.anchor.set(0.5,0.5);var h=game.add.sprite(0,0,'dots');h.anchor.set(0.5,-0.3),game.goalSignal=new Phaser.Signal,game.goalSignal.add(function(o){game.blueGroup.children.forEach(function(q){q.body.setZeroVelocity()}),game.redGroup.children.forEach(function(q){q.body.setZeroVelocity()}),game.ball.body.setZeroVelocity(),o?game.scores.blue+=1:game.scores.red+=1,game.check()?game.gameOverSignal.dispatch():game.showWinTablo(o)}),game.gameOverSignal=new Phaser.Signal,game.gameOverSignal.add(function(){game.hitArea.visible=!1;var o=game.add.emitter(-40,50,2e3);o.makeParticles(['p1','p2','p3','p4','p5','p6','p7','p8']),o.minParticleScale=0.5,o.maxParticleScale=1,o.start(!1,5e3,20,1e3);var q=game.add.emitter(420,-40,2e3);q.makeParticles(['p1','p2','p3','p4','p5','p6','p7','p8']),q.minParticleScale=0.5,q.maxParticleScale=1,q.start(!1,5e3,20,1e3);var u=game.add.emitter(900,50,2e3);u.makeParticles(['p1','p2','p3','p4','p5','p6','p7','p8']),u.minParticleScale=0.5,u.maxParticleScale=1,u.start(!1,5e3,20,1e3),game.win.visible=!0,setTimeout(function(){o.destroy(),q.destroy(),u.destroy(),game.win.visible=!1},1e4)}),game.showWinTablo=function(o){game.goal.visible=!0;var q=game.timeId;setTimeout(function(){q!=game.timeId||(game.goal.visible=!1,game.nextTime(o))},3e3)},game.nextStepSignal=new Phaser.Signal,game.nextStepSignal.add(function(o){console.log('nextStepSignal'),game.stepTimeLeft=game.stepTimeTotal,game._stepTimeLeft=game.time.time,game.guiLevel.updateDisplay(),game.isPause=!0;var q=game.leftLine.start.x,u=game.rightLine.start.x;o&&(o.bl.forEach(w=>{var z=w.width+Math.abs(game.speedOut*(w.x-q));console.log(q,w.x,z),w.body.velocity.x=z}),o.rl.forEach(w=>{var z=w.width+Math.abs(game.speedOut*(w.x-q));console.log(q,w.x,z),w.body.velocity.x=z}),o.br.forEach(w=>{var z=-(w.width+Math.abs(game.speedOut*(u-w.x)));console.log(q,w.x,u,z),w.body.velocity.x=z}),o.rr.forEach(w=>{var z=-(w.width+Math.abs(game.speedOut*(u-w.x)));console.log(q,w.x,u,z),w.body.velocity.x=z})),setTimeout(function(){game.isPause=!1,console.log('nextStepSignal - timeout'),game.blueGroup.children.forEach(function(w){w.body.setZeroVelocity()}),game.redGroup.children.forEach(function(w){w.body.setZeroVelocity()}),game.ball.body.setZeroVelocity(),game.blueCommand=!game.blueCommand,game.blueCommand?game.blueGroup.children.forEach(function(w){w.select.visible=!0,w.inputEnabled=!0,w.input.useHandCursor=!0}):game.redGroup.randomMove()},1e3)}),game.redGroup.randomMove=function(){console.log('randomMove');var o=getAiAngle(game),q=game.redGroup.children[o.id];console.log(q);var u=o.angle;if(game.ball.x-game.lx>game.width/6)var w=Phaser.Math.linear(0.7,1,Math.random());else var w=Phaser.Math.linear(0.25,1,Math.random());var z=4e3*Math.random();game.hitArea.x=q.x,game.hitArea.y=q.y,game.hitArea._scale=game.hitArea.scale.x,game.hitArea.visible=!0;var A=game.timeId;game.tweent=game.add.tween(game.hitArea).to({rotation:u,_scale:w},z,Phaser.Easing.Sinusoidal.InOut,!1);var B=game.tweent;B.onUpdateCallback(function(C){C.target.scale.set(C.target._scale)}),B.onComplete.add(function(){console.log('randomMove complete');game.timeId!=A||(console.log('complete'),game.hitArea.scale.set(w),console.log('body',toGrad(q.body.rotation)),setTimeout(function(){console.log('randomMove complete timeout');game.timeId!=A||(game.hitArea.visible=!1,console.log('start move'),setTimeout(function(){if(console.log('randomMove complete timeout timeout'),game.timeId==A){game.firstPanch&&(game.firstPanch=!1),game.isMoving=1,game.stepTimeLeft=game.stepTimeTotal;var C=u-Math.PI/2;q.body.velocity.x=Math.cos(C)*game.power*w,q.body.velocity.y=Math.sin(C)*game.power*w}},0))},500),game.redGroup.children.forEach(function(C){C.select.visible=!1}))}),game.redGroup.children.forEach(function(C){C.select.visible=!0}),B.start(),console.log('start')},game.boundRectLT=game.add.sprite(0,0,'dot'),game.physics.box2d.enable(game.boundRectLT),game.boundRectLT.body.setRectangle(60,194,30,97),game.boundRectLT.body.static=!0,game.boundRectLT.rect=new Phaser.Rectangle(0,0,60,194),game.boundRectRT=game.add.sprite(game.width-60,0,'dot'),game.physics.box2d.enable(game.boundRectRT),game.boundRectRT.body.setRectangle(60,194,30,97),game.boundRectRT.body.static=!0,game.boundRectRT.rect=new Phaser.Rectangle(game.width-60,0,60,194),game.boundRectT=game.add.sprite(0,0,'dot'),game.physics.box2d.enable(game.boundRectT),game.boundRectT.body.setRectangle(game.width,60,game.width/2,30),game.boundRectT.body.static=!0,game.boundRectT.rect=new Phaser.Rectangle(0,game.height-60,game.width,60),game.boundRectB=game.add.sprite(0,game.height-60,'dot'),game.physics.box2d.enable(game.boundRectB),game.boundRectB.body.setRectangle(game.width,60,game.width/2,30),game.boundRectB.body.static=!0,game.boundRectB.rect=new Phaser.Rectangle(0,0,game.width,60),game.ty=60,game.by=game.height-60,game.lx=game.leftLine.start.x,game.rx=game.rightLine.start.x,game.boundRectLB=game.add.sprite(0,game.height-194,'dot'),game.physics.box2d.enable(game.boundRectLB),game.boundRectLB.body.setRectangle(60,194,30,97),game.boundRectLB.body.static=!0,game.boundRectLB.rect=new Phaser.Rectangle(0,game.height-194,60,194),game.boundRectRB=game.add.sprite(game.width-60,game.height-194,'dot'),game.physics.box2d.enable(game.boundRectRB),game.boundRectRB.body.setRectangle(60,194,30,97),game.boundRectRB.body.static=!0,game.boundRectRB.rect=new Phaser.Rectangle(game.width-60,game.height-194,60,194),game.boundRectLGate=new Phaser.Rectangle(0,game.height/2-100,146,200),game.boundRectRGate=new Phaser.Rectangle(game.width-146,game.height/2-100,146,200),game.area=e,game.hitArea.add(e),game.hitArea.add(d),game.hitArea.add(h),game.isMoving=0,game.currentPlayer=null,game.ball=game.add.sprite(game.ballCoord.x,game.ballCoord.y,'ball'),game.bradius=game.ball.width/2,game.physics.box2d.enable(game.ball),game.ball.body.setCircle(game.ball.width/2),game.ball.body.mass=game.ballMass,game.ball.body.fixedRotation=!0,game.ball.body.linearDamping=game.ballDamping,game.mouse=new Phaser.Mouse(game);game.redTeamCoords.forEach((o,q)=>{var u=game.add.sprite(o.x,o.y,'circle50');game.redGroup.children.push(u),u.id=q,u.idx=q;var w=1,z=w*u.width/2;return game.radius||(game.radius=z),u.scale.set(w),game.physics.box2d.enable(u,!0),u.body.setCircle(z),u.body.mass=game.mass,u.body.fixedRotation=!0,u.body.rotation=rotate(0),u.body.linearDamping=game.damping,u.pwr=game.power,u.anchor.set(0.5,0.5),u.addChild(game.add.sprite(0,0,'redPl')),u.curTexture=u.children[0],u.curTexture.anchor.set(0.5,0.5),u.addChild(game.add.sprite(0,0,'select')),u.select=u.children[1],u.select.anchor.set(0.5,0.5),u.select.visible=!game.blueCommand,u}),game.blueTeamCoords.forEach((o,q)=>{var u=game.add.sprite(o.x,o.y,'circle50');game.blueGroup.children.push(u),u.id=q,u.idx=q;var w=1,z=w*u.width/2;return game.radius||(game.radius=z),u.scale.set(w),game.physics.box2d.enable(u,!0),u.body.setCircle(z),u.body.mass=game.mass,u.body.debug=!0,u.body.fixedRotation=!0,u.body.rotation=rotate(0),u.body.linearDamping=game.dampingP,u.pwr=game.powerP,u.rd=0,u.anchor.set(0.5,0.5),u.addChild(game.add.sprite(0,0,'bluePl')),u.addChild(game.add.sprite(0,0,'select')),u.select=u.children[1],u.select.anchor.set(0.5,0.5),u.curTexture=u.children[0],u.curTexture.anchor.set(0.5,0.5),u.select=u.children[1],u.select.anchor.set(0.5,0.5),u.select.visible=game.blueCommand,game.blueCommand&&(u.inputEnabled=!0,u.input.useHandCursor=!0),u.events.onInputDown.add(function(A){console.log('down'),game.hitArea.x=u.x,game.hitArea.y=u.y,game.hitArea.visible=!0,game.currentPlayer=A}),u.events.onInputUp.add(function(){console.log('up'),setTimeout(function(){game.isMoving=1,game.stepTimeLeft=game.stepTimeTotal,game.firstPanch&&(game.firstPanch=!1);var B=game.hitArea.rotation-Math.PI/2;u.body.velocity.x=Math.cos(B)*game.powerP*game.hitArea.scale.x,u.body.velocity.y=Math.sin(B)*game.powerP*game.hitArea.scale.x},0),game.currentPlayer=null,game.hitArea.visible=!1,game.blueGroup.children.forEach(function(B){B.select.visible=!1,B.inputEnabled=!1,B.input.useHandCursor=!1})}),u}),game.group=[],game.group=game.group.concat(game.redGroup.children),game.group=game.group.concat(game.blueGroup.children),console.log(game.group),game.gateL=game.add.sprite(0,253,'gate'),game.gateL.anchor.set(1,0.5),game.gateL.scale.set(-1,1),game.gateR=game.add.sprite(game.width-3,253,'gate'),game.gateR.anchor.set(1,0.5),game.goal=game.add.sprite(game.centerLine.start.x,game.height/2,'goal'),game.goal.anchor.set(0.5,0.5),game.goal.visible=!1,game.win=game.add.sprite(game.centerLine.start.x,game.height/2,'win'),game.win.anchor.set(0.5,0.5),game.win.visible=!1,game.fall=game.add.sprite(game.centerLine.start.x,game.height/2,'fall'),game.fall.anchor.set(0.5,0.5),game.fall.visible=!1,game.traectories=[],getAiAngle(game),game.setParam=function(){game.ball.body.mass=game.ballMass,game.ball.body.linearDamping=game.damping,game.redGroup.children.forEach(function(o){o.body.mass=game.mass,o.body.linearDamping=game.ballDamping}),game.blueGroup.children.forEach(function(o){o.body.mass=game.massP,o.body.linearDamping=game.dampingP}),game.angleSectors=game.angleSectorsString.replace(/\s/g,'').split(','),console.log(game.angleSectors)},game.restart=function(){game.initGame(),game.blueCommand=!!(0.5>Math.random()),game.isMoving=0,game.isRestarted=!0,game.hitArea.visible=!1,game.win.visible=!1,game.fall.visible=!1,game.goal.visible=!1,game.tweent&&(game.tweent=null),game.freeze(),game.blueGroup.children.forEach(function(o){o.select.visible=!1}),game.redGroup.children.forEach(function(o){o.select.visible=!1}),game.nextTime(game.blueCommand)},game.guiLevel=gui.addFolder('\u041F\u0430\u0440\u0430\u043C\u0435\u0442\u0440\u044B');var m=game.guiLevel;m.add(game,'power',0,4e3).name('\u0421\u0438\u043B\u0430'),m.add(game,'powerP',0,4e3).name('\u0421\u0438\u043B\u0430\u0418\u0433\u0440\u043E\u043A\u0430'),m.add(game,'mass',1,100).name('\u041C\u0430\u0441\u0441\u0430'),m.add(game,'massP',1,100).name('\u041C\u0430\u0441\u0441\u0430\u0418\u0433\u0440\u043E\u043A\u0430'),m.add(game,'ballMass',1,100).name('\u041C\u0430\u0441\u0441\u0430 \u043C\u044F\u0447\u0430'),m.add(game,'damping',0,5).name('\u0421\u043E\u043F\u0440\u043E\u0442\u0438\u0432\u043B\u0435\u043D\u0438\u0435'),m.add(game,'ballDamping',0,5).name('\u0421\u043E\u043F\u0440\u043E\u0442\u0438\u0432\u043B\u0435\u043D\u0438\u0435 \u043C\u044F\u0447\u0430'),m.add(game,'speedOut',1,15).name('\u0421\u043A\u043E\u0440\u043E\u0441\u0442\u044C\u0412\u044B\u043B\u0435\u0442\u0430'),m.add(game,'angleSectorsString').name('\u0423\u0433\u043B\u044BAI'),m.add(game,'setParam').name('\u041F\u0440\u0438\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0430\u0440\u0430\u043C\u0435\u0442\u0440\u044B'),m.add(game,'stepTimeLeft').name('\u0412\u0440\u0435\u043C\u044F'),m.add(game,'restart').name('Restart'),m.open(),game.blueCommand||setTimeout(function(){game.redGroup.randomMove()},500)}function update(){var d=game.time.time-game._stepTimeLeft;if(0>=game.updateDisplay&&(game.updateDisplay=500,game.guiLevel.updateDisplay()),game.input.mousePointer.isDown){if(!game.currentPlayer)return;var e=game.currentPlayer,h=Math.abs(getLength(e.x,e.y,game.input.mousePointer.x,game.input.mousePointer.y)),j=getAngle(e.x,e.y,game.input.mousePointer.x,game.input.mousePointer.y);e.oldrd=e.rd,1>=h?game.hitArea.scale.set(0.01):h<=game.area.width/2&&(scale=h/(game.area.width/2),game.hitArea.scale.set(scale)),game.hitArea.rotation=j}0<game.isMoving?testMotion():(game.stepTimeLeft-=d,game._stepTimeLeft=game.time.time,(!1==game.isPause||d>game.stepTimeTotal)&&(game.updateDisplay-=d),0>=game.stepTimeLeft&&!game.isGameOver&&(game.timeId=game.time.time,game.isGameOver=!0,game.gameOverSignal.dispatch(),game.guiLevel.updateDisplay(),console.log('time')))}function testMotion(){var d=moveDetect();if(d)1==game.isMoving&&(game.isMoving=2);else if(2==game.isMoving){game.isMoving=0,console.log('endmove'),console.log('isMoving',game.isMoving);var e=game.blueGroup.children.filter(o=>{return o.x<game.leftLine.start.x+o.width/2}),h=game.redGroup.children.filter(o=>{return o.x<game.leftLine.start.x+o.width/2}),j=game.blueGroup.children.filter(o=>{return o.x>game.rightLine.start.x-o.width/2}),m=game.redGroup.children.filter(o=>{return o.x>game.rightLine.start.x-o.width/2});game.nextStepSignal.dispatch({bl:e,br:j,rl:h,rr:m})}}function moveDetect(){var d=Math.abs(1<game.ball.body.velocity.x)||1<Math.abs(game.ball.body.velocity.y);return d=d||game.redGroup.children.some(e=>Math.abs(1<e.body.velocity.x)||1<Math.abs(e.body.velocity.y)),d=d||game.blueGroup.children.some(e=>Math.abs(1<e.body.velocity.x)||1<Math.abs(e.body.velocity.y)),d&&console.log('move'),game.ball.body.x<game.leftLine.start.x&&game.ball.y<game.height/2+100&&game.ball.y>game.height/2-100?(game.isMoving=0,game.firstPanch?game.fallStrikeSignal.dispatch():(game.isGoal=!0,game.goalSignal.dispatch(!1))):game.ball.body.x>game.rightLine.start.x&&game.ball.y<game.height/2+100&&game.ball.y>game.height/2-100&&(game.isMoving=0,game.firstPanch?game.fallStrikeSignal.dispatch():(game.isGoal=!0,game.goalSignal.dispatch(!0))),d}function render(){game.debug.geom(game.centerLine),game.debug.geom(game.leftLine),game.debug.geom(game.rightLine),game.blueGroup.children.forEach(d=>{game.debug.box2dBody(d.body)}),game.traectories.forEach(function(d){game.debug.geom(d)})}function tg(d){var e=Math.PI*d/180;return Math.tan(e)}function inrange(d,e,h){var j=Math.min(e,h),m=Math.max(e,h);return j<=d&&d<=m}function cos(d){var e=Math.PI*d/180;return Math.cos(e)}function sin(d){var e=Math.PI*d/180;return Math.sin(e)}function tan(d){var e=Math.PI*d/180;return Math.tan(e)}function tanc(d,e,h,j){return(h-j)/(d-e)}function atan(d){var e=Math.atan(d);return 180*e/Math.PI}function sign(d){return 0<d?1:0>d?-1:0}function getLength(d,e,h,j){return Math.sqrt((h-d)*(h-d)+(j-e)*(j-e))}function toRad(d){return Math.PI*d/180}function toGrad(d){return 180*d/Math.PI}function getAngle(d,e,h,j){var m=0;return m=d==h?j<e?0:Math.PI:e==j?d<h?Math.PI/2:3*(Math.PI/2):Math.atan((j-e)/(h-d)),d>h?m+=Math.PI/2:m-=Math.PI/2,m}