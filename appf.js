var gui=new dat.GUI,game=new Phaser.Game({width:820,height:530,renderer:Phaser.CANVAS,parent:'parent',transparent:!0,state:{transparent:!0,preload:preload,create:create,update,render}}),degToRad=Phaser.Math.degToRad,rotate=function(d){return degToRad(d+90)};function preload(){game.load.image('redPl','assets/red.png'),game.load.image('bluePl','assets/blue.png'),game.load.image('select','assets/select.png'),game.load.image('hit_arrow','assets/hit_arrow.png'),game.load.image('hit_area','assets/player_hitarea.png'),game.load.image('dot','assets/dot_hit.png'),game.load.image('dots','assets/dots.png'),game.load.image('pl','pangball.png'),game.load.image('ball','assets/ball.png'),game.load.image('gate','assets/gate.png'),game.load.image('goal','assets/goal.png'),game.load.image('win','assets/win.png'),game.load.image('p1','assets/particles/p1.png'),game.load.image('p2','assets/particles/p2.png'),game.load.image('p3','assets/particles/p3.png'),game.load.image('p4','assets/particles/p4.png'),game.load.image('p5','assets/particles/p5.png'),game.load.image('p6','assets/particles/p6.png'),game.load.image('p7','assets/particles/p7.png'),game.load.image('p8','assets/particles/p8.png')}game.initGame=function(){game.scores={red:0,blue:0},game.firstPanch=!1},game.check=function(){return 1<game.scores.red||1<game.scores.blue},game.freeze=function(){game.blueGroup.children.forEach(function(d){d.body.setZeroVelocity()}),game.redGroup.children.forEach(function(d){d.body.setZeroVelocity()}),game.ball.body.setZeroVelocity()},game.nextTime=function(d){game.redGroup.children.forEach(function(e){e.body.x=game.redTeamCoords[e.id].x,e.body.y=game.redTeamCoords[e.id].y}),game.blueGroup.children.forEach(function(e){e.body.x=game.blueTeamCoords[e.id].x,e.body.y=game.blueTeamCoords[e.id].y}),game.ball.body.x=game.ballCoord.x,game.ball.body.y=game.ballCoord.y,game.freeze(),game.blueCommand=!1,d&&(game.blueCommand=!0),game.nextStepSignal.dispatch()};function create(){game.initGame(),game.physics.startSystem(Phaser.Physics.P2JS),game.stage.backgroundColor='#12418400',game.physics.p2.gravity.y=0,game.physics.p2.restitution=1,game.centerLine=new Phaser.Line(game.width/2,(game.height-405)/2,game.width/2,(game.height-405)/2+405),game.leftLine=new Phaser.Line(60,(game.height-405)/2,60,(game.height-405)/2+405),game.rightLine=new Phaser.Line(game.width-60,(game.height-405)/2,game.width-60,(game.height-405)/2+405),game.mass=5,game.massP=5,game.power=1500,game.powerP=1500,game.ballMass=1,game.damping=0.9,game.dampingP=0.9,game.ballDamping=0.9,game.speedOut=6,game.redTeamCoords=[{x:game.width-340,y:265},{x:game.width-285,y:380},{x:game.width-285,y:150},{x:game.width-200,y:220},{x:game.width-200,y:310}],game.blueTeamCoords=[{x:340,y:265},{x:285,y:380},{x:285,y:150},{x:200,y:220},{x:200,y:310}],game.ballCoord={x:410,y:265},game.blueCommand=!0,game.redGroup=game.add.physicsGroup(Phaser.Physics.P2JS),game.blueGroup=game.add.physicsGroup(Phaser.Physics.P2JS),game.hitArea=game.add.group();var d=game.add.sprite(0,0,'hit_arrow');d.anchor.set(0.5,1.3);var e=game.add.sprite(0,0,'hit_area');e.anchor.set(0.5,0.5);var h=game.add.sprite(0,0,'dots');h.anchor.set(0.5,-0.3),game.goalSignal=new Phaser.Signal,game.goalSignal.add(function(o){game.blueGroup.children.forEach(function(q){q.body.setZeroVelocity()}),game.redGroup.children.forEach(function(q){q.body.setZeroVelocity()}),game.ball.body.setZeroVelocity(),o?game.scores.blue+=1:game.scores.red+=1,game.check()?game.gameOverSignal.dispatch():game.showWinTablo(o)}),game.gameOverSignal=new Phaser.Signal,game.gameOverSignal.add(function(){var o=game.add.emitter(-40,50,200);o.makeParticles(['p1','p2','p3','p4','p5','p6','p7','p8']),o.minParticleScale=0.5,o.maxParticleScale=1,o.start(!1,5e3,20,100);var q=game.add.emitter(420,-40,200);q.makeParticles(['p1','p2','p3','p4','p5','p6','p7','p8']),q.minParticleScale=0.5,q.maxParticleScale=1,q.start(!1,5e3,20,100);var u=game.add.emitter(900,50,200);u.makeParticles(['p1','p2','p3','p4','p5','p6','p7','p8']),u.minParticleScale=0.5,u.maxParticleScale=1,u.start(!1,5e3,20,100),game.win.visible=!0,setTimeout(function(){o.destroy(),q.destroy(),u.destroy(),game.win.visible=!1},1e4)}),game.showWinTablo=function(o){game.goal.visible=!0,setTimeout(function(){game.goal.visible=!1,game.nextTime(o)},3e3)},game.nextStepSignal=new Phaser.Signal,game.nextStepSignal.add(function(o){game.firstPanch&&(game.firstPanch=!1);var q=game.leftLine.start.x,u=game.rightLine.start.x;o&&(o.bl.forEach(w=>{var z=w.width+Math.abs(game.speedOut*(w.x-q));console.log(q,w.x,z),w.body.velocity.x=z}),o.rl.forEach(w=>{var z=w.width+Math.abs(game.speedOut*(w.x-q));console.log(q,w.x,z),w.body.velocity.x=z}),o.br.forEach(w=>{var z=-(w.width+Math.abs(game.speedOut*(u-w.x)));console.log(q,w.x,u,z),w.body.velocity.x=z}),o.rr.forEach(w=>{var z=-(w.width+Math.abs(game.speedOut*(u-w.x)));console.log(q,w.x,u,z),w.body.velocity.x=z})),setTimeout(function(){game.blueGroup.children.forEach(function(w){w.body.setZeroVelocity()}),game.redGroup.children.forEach(function(w){w.body.setZeroVelocity()}),game.ball.body.setZeroVelocity(),game.blueCommand=!game.blueCommand,game.blueCommand?game.blueGroup.forEach(function(w){w.select.visible=!0,w.inputEnabled=!0,w.input.useHandCursor=!0}):game.redGroup.randomMove()},1e3)}),game.redGroup.randomMove=function(){var o=getAiAngle(game),q=game.redGroup.children[o.id];console.log(q);var u=o.angle,w=(Math.random()+1)/2,z=4e3*Math.random();game.hitArea.x=q.x,game.hitArea.y=q.y,game.hitArea._scale=game.hitArea.scale.x,game.hitArea.visible=!0;var A=game.add.tween(game.hitArea).to({rotation:u,_scale:w},z,Phaser.Easing.Sinusoidal.InOut,!1);A.onUpdateCallback(function(B){B.target.scale.set(B.target._scale)}),A.onComplete.add(function(){console.log('complete'),game.hitArea.scale.set(w),q.body.rotation=u,console.log('body',toGrad(q.body.rotation)),setTimeout(function(){game.hitArea.visible=!1,console.log('start move'),setTimeout(function(){game.isMoving=1,q.body.moveForward(game.power*w)},0)},500),game.redGroup.children.forEach(function(B){B.select.visible=!1})}),game.redGroup.children.forEach(function(B){B.select.visible=!0}),A.start(),console.log('start')},game.boundRectLT=game.add.sprite(0,0,'dot'),game.physics.p2.enable(game.boundRectLT),game.boundRectLT.body.setRectangle(60,194,30,97),game.boundRectLT.body.static=!0,game.boundRectLT.rect=new Phaser.Rectangle(0,0,60,194),game.boundRectRT=game.add.sprite(game.width-60,0,'dot'),game.physics.p2.enable(game.boundRectRT),game.boundRectRT.body.setRectangle(60,194,30,97),game.boundRectRT.body.static=!0,game.boundRectRT.rect=new Phaser.Rectangle(game.width-60,0,60,194),game.boundRectT=game.add.sprite(0,0,'dot'),game.physics.p2.enable(game.boundRectT),game.boundRectT.body.setRectangle(game.width,60,game.width/2,30),game.boundRectT.body.static=!0,game.boundRectT.rect=new Phaser.Rectangle(0,game.height-60,game.width,60),game.boundRectB=game.add.sprite(0,game.height-60,'dot'),game.physics.p2.enable(game.boundRectB),game.boundRectB.body.setRectangle(game.width,60,game.width/2,30),game.boundRectB.body.static=!0,game.boundRectB.rect=new Phaser.Rectangle(0,0,game.width,60),game.ty=60,game.by=game.height-60,game.lx=game.leftLine.start.x,game.rx=game.rightLine.start.x,game.boundRectLB=game.add.sprite(0,game.height-194,'dot'),game.physics.p2.enable(game.boundRectLB),game.boundRectLB.body.setRectangle(60,194,30,97),game.boundRectLB.body.static=!0,game.boundRectLB.rect=new Phaser.Rectangle(0,game.height-194,60,194),game.boundRectRB=game.add.sprite(game.width-60,game.height-194,'dot'),game.physics.p2.enable(game.boundRectRB),game.boundRectRB.body.setRectangle(60,194,30,97),game.boundRectRB.body.static=!0,game.boundRectRB.rect=new Phaser.Rectangle(game.width-60,game.height-194,60,194),game.boundRectLGate=new Phaser.Rectangle(0,game.height/2-100,146,200),game.boundRectRGate=new Phaser.Rectangle(game.width-146,game.height/2-100,146,200),game.area=e,game.hitArea.add(e),game.hitArea.add(d),game.hitArea.add(h),game.isMoving=0,game.currentPlayer=null,game.ball=game.add.sprite(game.ballCoord.x,game.ballCoord.y,'ball'),game.bradius=game.ball.width/2,game.physics.p2.enable(game.ball),game.ball.body.setCircle(game.ball.width/2),game.ball.body.mass=game.ballMass,game.ball.body.fixedRotation=!0,game.ball.body.damping=game.ballDamping,game.mouse=new Phaser.Mouse(game);game.redTeamCoords.forEach((o,q)=>{var u=game.redGroup.create(o.x,o.y,'redPl');u.id=q,u.idx=q;var w=1,z=w*u.width/2;return game.radius||(game.radius=z),u.scale.set(w),u.body.setCircle(z),game.physics.p2.enable(u),u.body.mass=game.mass,u.body.fixedRotation=!0,u.body.rotation=rotate(0),u.body.damping=game.damping,u.pwr=game.power,u.anchor.set(0.5,0.5),u.addChild(game.add.sprite(0,0,'select')),u.select=u.children[0],u.select.anchor.set(0.5,0.5),u.select.visible=!game.blueCommand,u}),game.blueTeamCoords.forEach((o,q)=>{var u=game.blueGroup.create(o.x,o.y,'bluePl');u.id=q,u.idx=0+5;var w=1,z=w*u.width/2;return void 0==game.scaleRatio&&(game.scaleRatio=game.area.width/u.width),u.selectTeam=!1,u.isSelect=game.blueCommand,u.scale.set(w),u.body.setCircle(z),u.body.mass=game.mass,game.physics.p2.enable(u),u.body.fixedRotation=!0,u.body.rotation=rotate(0),u.body.damping=game.dampingP,u.pwr=game.powerP,u.rd=0,u.anchor.set(0.5,0.5),u.addChild(game.add.sprite(0,0,'select')),u.select=u.children[0],u.select.anchor.set(0.5,0.5),u.select.visible=game.blueCommand,game.blueCommand&&(u.inputEnabled=!0,u.input.useHandCursor=!0),u.events.onInputDown.add(function(A){console.log('down'),game.hitArea.x=u.x,game.hitArea.y=u.y,game.hitArea.visible=!0,game.currentPlayer=A}),u.events.onInputUp.add(function(A){console.log('up'),A.body.rotation=game.hitArea.rotation,setTimeout(function(){game.isMoving=1,console.log(game.isMoving=1),A.body.moveForward(game.powerP*game.hitArea.scale.x)},0),game.currentPlayer=null,game.hitArea.visible=!1,game.blueGroup.forEach(function(B){B.select.visible=!1,B.inputEnabled=!1,B.input.useHandCursor=!1})}),u}),game.group=[],game.group=game.group.concat(game.redGroup.children),game.group=game.group.concat(game.blueGroup.children),console.log(game.group),game.gateL=game.add.sprite(0,253,'gate'),game.gateL.anchor.set(1,0.5),game.gateL.scale.set(-1,1),game.gateR=game.add.sprite(game.width-3,253,'gate'),game.gateR.anchor.set(1,0.5),game.goal=game.add.sprite(game.centerLine.start.x,game.height/2,'goal'),game.goal.anchor.set(0.5,0.5),game.goal.visible=!1,game.win=game.add.sprite(game.centerLine.start.x,game.height/2,'win'),game.win.anchor.set(0.5,0.5),game.win.visible=!1,game.traectories=[],getAiAngle(game),game.setParam=function(){game.ball.body.mass=game.ballMass,game.ball.body.damping=game.damping,game.redGroup.children.forEach(function(o){o.body.mass=game.mass,o.body.damping=game.ballDamping}),game.blueGroup.children.forEach(function(o){o.body.mass=game.massP,o.body.damping=game.dampingP})};var m=gui.addFolder('\u041F\u0430\u0440\u0430\u043C\u0435\u0442\u0440\u044B');m.add(game,'power',0,4e3).name('\u0421\u0438\u043B\u0430'),m.add(game,'powerP',0,4e3).name('\u0421\u0438\u043B\u0430\u0418\u0433\u0440\u043E\u043A\u0430'),m.add(game,'mass',1,100).name('\u041C\u0430\u0441\u0441\u0430'),m.add(game,'massP',1,100).name('\u041C\u0430\u0441\u0441\u0430\u0418\u0433\u0440\u043E\u043A\u0430'),m.add(game,'ballMass',1,100).name('\u041C\u0430\u0441\u0441\u0430 \u043C\u044F\u0447\u0430'),m.add(game,'damping',0,1).name('\u0421\u043E\u043F\u0440\u043E\u0442\u0438\u0432\u043B\u0435\u043D\u0438\u0435'),m.add(game,'ballDamping',0,1).name('\u0421\u043E\u043F\u0440\u043E\u0442\u0438\u0432\u043B\u0435\u043D\u0438\u0435 \u043C\u044F\u0447\u0430'),m.add(game,'speedOut',1,15).name('\u0421\u043A\u043E\u0440\u043E\u0441\u0442\u044C\u0412\u044B\u043B\u0435\u0442\u0430'),m.add(game,'setParam').name('\u041F\u0440\u0438\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0430\u0440\u0430\u043C\u0435\u0442\u0440\u044B'),m.open()}function update(){if(game.input.mousePointer.isDown){if(!game.currentPlayer)return;var d=game.currentPlayer,e=Math.abs(getLength(d.x,d.y,game.input.mousePointer.x,game.input.mousePointer.y)),h=getAngle(d.x,d.y,game.input.mousePointer.x,game.input.mousePointer.y);d.oldrd=d.rd,1>=e?(d.scale.set(0.01),game.hitArea.scale.set(scale)):e<=game.area.width/2&&(scale=e/(game.area.width/2),game.hitArea.scale.set(scale));game.hitArea.rotation=h}0<game.isMoving&&testMotion()}function testMotion(){var d=moveDetect();if(d)1==game.isMoving&&(game.isMoving=2);else if(2==game.isMoving){game.isMoving=0,console.log('endmove'),console.log('isMoving',game.isMoving);var e=game.blueGroup.children.filter(o=>{return o.x<game.leftLine.start.x+o.width/2}),h=game.redGroup.children.filter(o=>{return o.x<game.leftLine.start.x+o.width/2}),j=game.blueGroup.children.filter(o=>{return o.x>game.rightLine.start.x-o.width/2}),m=game.redGroup.children.filter(o=>{return o.x>game.rightLine.start.x-o.width/2});game.nextStepSignal.dispatch({bl:e,br:j,rl:h,rr:m})}}function moveDetect(){var d=Math.abs(1<game.ball.body.velocity.x)||1<Math.abs(game.ball.body.velocity.y);return d=d||game.redGroup.children.some(e=>Math.abs(1<e.body.velocity.x)||1<Math.abs(e.body.velocity.y)),d=d||game.blueGroup.children.some(e=>Math.abs(1<e.body.velocity.x)||1<Math.abs(e.body.velocity.y)),d&&console.log('move'),game.ball.body.x<game.leftLine.start.x&&game.ball.y<game.height/2+100&&game.ball.y>game.height/2-100?(game.isMoving=0,game.isGoal=!0,game.goalSignal.dispatch(!1)):game.ball.body.x>game.rightLine.start.x&&game.ball.y<game.height/2+100&&game.ball.y>game.height/2-100&&(game.isMoving=0,game.isGoal=!0,game.goalSignal.dispatch(!0)),d}function render(){game.debug.geom(game.centerLine),game.debug.geom(game.leftLine),game.debug.geom(game.rightLine),game.traectories.forEach(function(d){game.debug.geom(d)})}function tg(d){var e=Math.PI*d/180;return Math.tan(e)}function inrange(d,e,h){var j=Math.min(e,h),m=Math.max(e,h);return j<=d&&d<=m}function cos(d){var e=Math.PI*d/180;return Math.cos(e)}function sin(d){var e=Math.PI*d/180;return Math.sin(e)}function tan(d){var e=Math.PI*d/180;return Math.tan(e)}function tanc(d,e,h,j){return(h-j)/(d-e)}function atan(d){var e=Math.atan(d);return 180*e/Math.PI}function sign(d){return 0<d?1:0>d?-1:0}function getLength(d,e,h,j){return Math.sqrt((h-d)*(h-d)+(j-e)*(j-e))}function toRad(d){return Math.PI*d/180}function toGrad(d){return 180*d/Math.PI}function getAngle(d,e,h,j){var m=0;return m=d==h?j<e?0:Math.PI:e==j?d<h?Math.PI/2:3*(Math.PI/2):Math.atan((j-e)/(h-d)),d>h?m+=Math.PI/2:m-=Math.PI/2,m}function getAiAngle(d){var e=d.leftLine.start.x,h=d.height/2,j=d.ball.x,m=d.ball.y;d.traectories=[];var o=d.bradius,q=d.radius,u=o+q;console.log('ai');var w=[],z=continueLine(e,h,j,m);w.push([{x:e,y:h,x1:j,y1:m,x2:z.x,y2:z.y}]);var A=d.ty,B=d.by,C=function(){var I=h-A,K=e+I*(j-e)/(I+(m-A)),L=Phaser.Math.angleBetween(j,m,K,A),M=tanc(K,j,A,m),N=u*Math.sin(L),O=u*Math.cos(L);return{x:e,y:h,x1:K,y1:A,x2:j,y2:m}}();z=continueLine(C.x1,C.y1,C.x2,C.y2),console.log(z),w.push([{x:C.x,y:C.y,x1:C.x1,y1:C.y1},{x:C.x1,y:C.y1,x1:j,y1:m,x2:z.x,y2:z.y}]);var C=function(){var I=B-h,K=e+I*(j-e)/(I+(B-m)),L=Phaser.Math.angleBetween(j,m,K,A),M=tanc(K,j,A,m),N=u*Math.sin(L),O=u*Math.cos(L);return{x:e,y:h,x1:K,y1:B,x2:j,y2:m}}();z=continueLine(C.x1,C.y1,C.x2,C.y2),console.log(z),w.push([{x:C.x,y:C.y,x1:C.x1,y1:C.y1},{x:C.x1,y:C.y1,x1:j,y1:m,x2:z.x,y2:z.y}]);var D=[];w.forEach(function(H){var J=!0;H.forEach(function(O){var O=findNormal({x:O.x,y:O.y,x1:O.x1,y1:O.y1,curang:toGrad(Phaser.Math.angleBetween(O.x,O.y,O.x1,O.y1))},-1,o);0<O.newtracks.length&&(J=!1)}),H.forEach(function(O){J&&d.traectories.push(new Phaser.Line(O.x,O.y,O.x1,O.y1))});var K=H[H.length-1],L=K.x2,M=K.y2,N=d.redGroup.children.map(function(O){var Q=180,R=new Phaser.Point(L,M),S=new Phaser.Point(O.x,O.y);Q=Phaser.Math.angleBetweenPoints(R,S);var T=findNormal({x:O.x,y:O.y,x1:L,y1:M,curang:toGrad(Q)},O.idx,q),U=!1;return 0==T.newtracks.length&&infield(L,M)&&(console.log(R,S),J&&d.traectories.push(new Phaser.Line(O.x,O.y,L,M)),U=!0),{ang:Q,x:O.x,y:O.y,id:O.id,isCan:U,isCanTr:J}});D=D.concat(N)}),D=D.filter(function(H){return H});var E=D.reduce(function(H,I){return Math.abs(I.ang)<Math.abs(H.ang)&&I.isCan&&I.isCanTr?I:H},{ang:10,id:-1}),F=D.reduce(function(H,I){return Math.abs(I.ang)<Math.abs(H.ang)?I:H},{ang:10});-1!==E.id&&(F=E);var G=F.ang;return{angle:G-Math.PI/2,id:F.id}}function findNormal(d,e,h){game.ids||(game.ids=[]);var j=game.radius+h,m=game.group.filter(z=>{return-1===e||z.idx!=e&&-1==game.ids.indexOf(z.idx)}),o=[],q=[];m.forEach(z=>{var A=tan(d.curang),B;if(0==A)var C=z.x,D=d.y,E=0,F=d.y;else{B=atan(A)-90;var E=tan(B),G=d.y-A*d.x,F=z.y-E*z.x,C=(F-G)/(A-E),D=E*C+F}var H=getLength(z.x,z.y,C,D);if(inrange(C,d.x,d.x1)&&H<j){o.push(new Phaser.Line(z.x,z.y,C,D));var I=Math.sqrt(j**2-H**2),J=sin(atan(A))*I,K=cos(atan(A))*I;if(C<z.x)var L=C+K;else var L=C-K;if(D<z.y)var M=D+J;else var M=D-J;var N=new Phaser.Line(z.x,z.y,L,M),O=tanc(z.x,L,z.y,M),P=atan(O);if(90<d.curang?P=180+P:-90>d.curang&&(P=-180-P),d.curang>P)var Q=P+90;else var Q=P-90;q.push({x:z.x,y:z.y,x1:L,y1:M,len:getLength(z.x,z.y,L,M),tn:O,ang:P,vec:N,ang2:Q})}});var u=q.reduce((z,A)=>{if(-1==z)return A.len;return A.len<z?A.len:z},-1),w=q.filter(z=>z.len==u);return{newtracks:w}}function continueLine(d,e,h,j){var m=Phaser.Math.angleBetween(d,e,h,j),o=game.bradius+game.radius,q=o*Math.sin(m),u=o*Math.cos(m);return{x:h+u,y:j+q}}function infield(d,e){var h=game.radius;return game.lx+h<=d&&d<=game.rx-h&&game.tx+h<=e&&e<=game.by-h}